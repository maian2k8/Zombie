<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Plants vs Zombies ‚Äî 5√ó9 Grid</title>
<style>
  :root{
    --bg:#0f1d12; --panel:#142418; --text:#e6f3e6;
    --chip:#17301f; --chip-b:#2b4c33; --accent:#e4ff6a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b160e,#0f1d12);
       font:15px/1.45 system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
  .wrap{max-width:1000px;margin:18px auto;padding:12px}
  .panel{background:var(--panel);border:1px solid #1e3423;border-radius:14px;padding:14px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  h1{margin:0 0 10px;font-size:20px}
  .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
  .shop{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .card{background:#183722;border:1px solid #2b4c33;border-radius:10px;padding:6px 9px;cursor:pointer;user-select:none}
  .card.disabled{opacity:.45;filter:grayscale(30%);cursor:not-allowed}
  .card.active{outline:2px solid var(--accent)}
  .right{display:flex;gap:8px;align-items:center}
  .pill{background:var(--chip);border:1px solid var(--chip-b);border-radius:999px;padding:5px 9px}
  button{appearance:none;border:1px solid #2b4c33;background:#193622;color:var(--text);padding:7px 12px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  input[type=file]{display:none}
  label.file{border:1px dashed #345d3f;border-radius:10px;padding:6px 10px;cursor:pointer}
  canvas{display:block;background:#000;border-radius:12px;box-shadow:inset 0 0 0 1px #132414}
  #hud{margin-top:8px;font-size:14px;display:flex;gap:12px;align-items:center}
  .small{font-size:12px;color:#bfe2bf}
  .credit{margin-top:8px}
  #banner{position:absolute;left:50%;top:64px;transform:translateX(-50%);
    background:rgba(0,0,0,.65);padding:10px 14px;border-radius:12px;
    backdrop-filter:blur(4px);border:1px solid #334;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>Mini Plants vs Zombies ‚Äî 5√ó9 Grid</h1>

    <div class="bar">
      <div class="left">
        <span class="pill">üñ±Ô∏è Tr√°i: ƒë·∫∑t c√¢y</span>
        <span class="pill">üñ±Ô∏è Ph·∫£i: x√≥a c√¢y</span>
        <span class="pill">R: ch∆°i l·∫°i</span>
      </div>
      <div class="right">
        <label class="file">
          <input id="bgUpload" type="file" accept="image/*">
          üì∑ Ch·ªçn ·∫£nh n·ªÅn
        </label>
        <button id="restart">Ch∆°i l·∫°i</button>
      </div>
    </div>

    <div class="shop" id="shop"></div>

    <canvas id="game" width="900" height="600"></canvas>
    <div id="hud">
      ‚òÄÔ∏è Sun: <b id="sun">50</b> |
      üåä Wave: <b id="wave">1</b> |
      ƒêang ch·ªçn: <b id="sel">Peashooter</b>
    </div>
  </div>
</div>

<div id="banner">‚ö†Ô∏è A Huge Wave of Zombies is Approaching!</div>
<audio id="drum" src="drum.mp3" preload="auto"></audio>

<script>
  /* ========================== NH·∫†C N·ªÄN ========================== */
const bgm = {
  track1: new Audio("./music1.mp3"), // cho wave 1‚Äì20
  track2: new Audio("./music2.mp3"), // cho wave 21‚Äì40
};
bgm.track1.loop = true;
bgm.track2.loop = true;

let currentTrack = null;
function playBgm(track){
  if(currentTrack) currentTrack.pause();   // d·ª´ng nh·∫°c c≈©
  currentTrack = bgm[track];
  if(currentTrack){
    currentTrack.currentTime = 0;
    currentTrack.play().catch(()=>{});    // tr√°nh l·ªói autoplay
  }
}

/* ========================== √ÇM THANH ========================== */
const sounds = {
  explosion: new Audio("explosion.mp3"),
  plant:     new Audio("plant.mp3"),
  pea:       new Audio("pea.mp3"),
  sun:       new Audio("sun.mp3"),
  zombie:    new Audio("zombie.mp3"),
};

const bossSound = new Audio("./boss.mp3"),
bossSound.volume = 1; // ch·ªânh √¢m l∆∞·ª£ng
bossSound.loop = true; // üåü nh·∫°c boss ch·∫°y l·∫∑p cho ƒë·∫øn khi stop

// Cho ph√©p nhi·ªÅu hi·ªáu ·ª©ng n·ªï c√πng l√∫c ‚Üí clone
function playSound(name) {
  const s = sounds[name];
  if (!s) return;
  const clone = s.cloneNode(); 
  clone.play().catch(()=>{}); // tr√°nh l·ªói autoplay
}

/* ========================== üîß CH·ªñ ƒê·ªîI H√åNH ==========================
   ƒê·∫∑t file ·∫£nh c·ªßa b·∫°n c√πng th∆∞ m·ª•c v·ªõi index.html v√† ƒë·ªïi t√™n b√™n d∆∞·ªõi.
   Ho·∫∑c b·∫•m n√∫t "üì∑ Ch·ªçn ·∫£nh n·ªÅn" ƒë·ªÉ ch·ªçn ·∫£nh n·ªÅn t·ª´ m√°y.
===================================================================== */
const SPRITES = {
  bg:           "./nen.png", // ·∫¢nh n·ªÅn (1 t·∫•m) ‚Äî c√≥ th·ªÉ ƒë·ªïi b·∫±ng n√∫t upload
  sunflower:    "./flower.png",
  peashooter:   "./peashooter.png",
  snowpea:      "./snowpea.png",
  repeater:     "./repeater.png",
  gaplin:       "./gaplin.png",
  cabbage:      "./cabbage.png",
  wallnut:      "./walnut.png",
  bomb:         "./cherry.png",
  torchwood:    "./torchwood.png",
  mine:         "./potato.png",
  zombie:       "./zombie.png",
  flagZombie:   "./flagZombie.png",
  sun:          "./coin.png",
  peashooter_bullet:   "./peagreen.png",
  snowpea_bullet:      "./peablue.png",
  repeater_bullet:     "./peadupple.png",
  peafire_bullet:      "./peafire.png",
  cabbage_bullet:      "./cabbagepea.png",
  florentino:          "./florentino.png",
  mobilezombie:        "./mobilezombie.png",
  horse:               "./horse.png",
};

// T·∫°o ƒë·ªëi t∆∞·ª£ng Image v√† load
const IMG = {};
for (const k in SPRITES) {
  IMG[k] = new Image();
  IMG[k].src = SPRITES[k] || "";
}

/* ========================== C·∫§U H√åNH & BI·∫æN ========================== */
const W=900,H=500,ROWS=5,COLS=9,TW=W/COLS,TH=H/ROWS;
const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
const bgUpload=document.getElementById("bgUpload");
const drum=document.getElementById("drum");
const banner=document.getElementById("banner");

const shopList=[
  {id:"peashooter",name:"üå± Peashooter",cost:100},
  {id:"snowpea",name:"‚ùÑÔ∏è Snow Pea",cost:175},
  {id:"repeater",name:"üå±üå± Repeater",cost:200},
  {id:"gaplin",name:"üå±üå±üå±Gaplin",cost:1500},
  {id:"cabbage",name:"ü•¨Cabbage",cost:100},
  {id:"sunflower",name:"üåª Sunflower",cost:50},
  {id:"wallnut",name:"ü•ú Wall-nut",cost:50},
  {id:"bomb",name:"üí£ Cherry Bomb",cost:150},
  {id:"torchwood",name:"üî• Torchwood",cost:125},
  {id:"mine",name:"ü•î Potato Mine",cost:25}
];

let selected = "peashooter";
let sun=50, wave=1, playing=true;
let grid=[...Array(ROWS)].map(()=>Array(COLS).fill(null));
let plants=[], peas=[], zombies=[], suns=[];
let zombiesLeft=6, spawnDelay=180, spawnTimer=spawnDelay, hugeShown=false;

/* ========================== TI·ªÜN √çCH ========================== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const cellOf=(x,y)=>{
  const c=Math.floor(x/TW), r=Math.floor(y/TH);
  if(c<0||c>=COLS||r<0||r>=ROWS) return null;
  return {r,c};
};
const center=(r,c)=>({x:c*TW+TW/2,y:r*TH+TH/2});
function addSun(x,y,amt=25){suns.push(new Sun(x,y,amt,));}

/* ========================== ENTITIES ========================== */
class Plant{
  constructor(r,c){this.row=r;this.col=c;this.hp=50;this.cool=0;}
  get x(){return this.col*TW+TW/2} get y(){return this.row*TH+TH/2}
  img(){return IMG[this.type] && IMG[this.type].complete ? IMG[this.type] : null;}
  drawBox(color="#4caf50"){ctx.fillStyle=color;ctx.fillRect(this.x-22,this.y-28,44,56);}
  draw(){const im=this.img(); if(im){ctx.drawImage(im,this.x-30,this.y-40,60,60);} else {this.drawBox();}}
  step(){}
}
class Peashooter extends Plant{
  constructor(r,c){ super(r,c); this.type="peashooter"; this.rate=60; this.hp=60; }
  step(){
    if(this.cool>0){this.cool--;}
    else if(zombies.some(z=>z.row===this.row&&z.x>this.x)){
      peas.push(new Pea(this.x+18,this.y,"peashooter_bullet"));
      this.cool=this.rate;
    }
  }
}

class SnowPea extends Plant{
  constructor(r,c){ super(r,c); this.type="snowpea"; this.rate=80; this.hp=60; }
  step(){
    if(this.cool>0){this.cool--;}
    else if(zombies.some(z=>z.row===this.row&&z.x>this.x)){
      peas.push(new Pea(this.x+18,this.y,"snowpea_bullet"));
      this.cool=this.rate;
    }
  }
}

class Repeater extends Plant{
  constructor(r,c){ super(r,c); this.type="repeater"; this.rate=70; this.hp=60; }
  step(){
    if(this.cool>0){this.cool--;}
    else if(zombies.some(z=>z.row===this.row&&z.x>this.x)){
      peas.push(new Pea(this.x+18,this.y,"repeater_bullet"));
      peas.push(new Pea(this.x+26,this.y,"repeater_bullet"));
      this.cool=this.rate;
    }
  }
}

class Gaplin extends Plant{
  constructor(r,c){ super(r,c); this.type="gaplin"; this.rate=10; this.hp=100; }
  step(){
    if(this.cool>0){this.cool--;}
    else if(zombies.some(z=>z.row===this.row&&z.x>this.x)){
      peas.push(new Pea(this.x+18,this.y,"peashooter_bullet"));
      peas.push(new Pea(this.x+26,this.y,"peashooter_bullet"));
      this.cool=this.rate;
    }
  }
}

class Cabbage extends Plant{
  constructor(r,c){ super(r,c); this.type="cabbage"; this.rate=60; this.hp=60; }
  step(){
    if(this.cool>0){this.cool--;}
    else if(zombies.some(z=>z.row===this.row&&z.x>this.x)){
      peas.push(new Pea(this.x+18,this.y,"cabbage_bullet"));
      this.cool=this.rate;
    }
  }
}

class Sunflower extends Plant{
  constructor(r,c){super(r,c);this.type="sunflower";this.rate=360;this.hp=40;}
  step(){if(this.cool>0){this.cool--;}else{addSun(this.x,this.y-18,25);this.cool=this.rate;}}
}
class Sun{
  constructor(x,y,amt=25){ 
    this.x=x; 
    this.y=y; 
    this.amt=amt; 
    this.life=2400; 
  }

  draw(){ 
    const img = IMG.sun;
    if(img && img.complete) {
        ctx.drawImage(img, this.x-20, this.y-20, 40, 40);
    } else {
        ctx.fillStyle = "gold";
        ctx.beginPath();
        ctx.arc(this.x, this.y, 14, 0, Math.PI*2);
        ctx.fill();
    }
  }

  update(){ this.life--; }
}

class Wallnut extends Plant{
  constructor(r,c){super(r,c);this.type="wallnut";this.hp=2000;}
  draw(){const im=this.img(); if(im){ctx.drawImage(im,this.x-34,this.y-36,68,68);} else {this.drawBox("#8b5a2b");}}
}
class Bomb extends Plant{
  constructor(r,c){super(r,c);this.type="bomb";this.timer=90;this.hp=100;}
  step(){this.timer--; if(this.timer<=0){
    zombies.forEach(z=>{if(Math.abs(z.x-this.x)<100 && Math.abs(z.y-this.y)<80) z.hp=0;});
    removePlant(this.row,this.col);
  }}
}
class Torchwood extends Plant{
  constructor(r,c){super(r,c);this.type="torchwood";this.hp=60;}
}
class Mine extends Plant{
  constructor(r,c){
    super(r,c);
    this.type="mine";
    this.armed=false;
    this.arm=420; // 7 gi√¢y ~ 420 frame
    this.hp=40;
  }
  explode(z){
  if(z instanceof MobileZombie){
    z.hp -= 200;  // m·∫•t 200 m√°u, kh√¥ng ch·∫øt ngay
  }else if(z instanceof HorseZombie){ 
    z.hp -= 350;  // m·∫•t 350 m√°u, kh√¥ng ch·∫øt ngay
  }else if(z instanceof FlorentinoZombie){
    z.hp -= 300;  // Boss ch·ªâ m·∫•t 300 m√°u
  } else if(z instanceof FlagZombie){
    z.hp = 0;     // FlagZombie ch·∫øt
  } else {
    z.hp = 0;     // zombie th∆∞·ªùng ch·∫øt lu√¥n
  }
  removePlant(this.row, this.col); // m√¨n bi·∫øn m·∫•t
  }

  step(){
  if(!this.armed){
    this.arm--;
    if(this.arm<=0) this.armed=true;
    return;
  }
    for(const z of zombies){
      if(z.row === this.row && z.x < this.x + 20 && z.x > this.x - 40){
        this.explode(z); // g·ªçi h√†m explode
        return;
      }
    }
  }

  draw(){
    const im=this.img();
    if(im){
      if(this.armed){
        ctx.drawImage(im,this.x-28,this.y-28,56,56);
      }else{
        ctx.globalAlpha=0.5; // m·ªù khi ch∆∞a armed
        ctx.drawImage(im,this.x-24,this.y-24,48,48);
        ctx.globalAlpha=1;
      }
    }else{
      this.drawBox(this.armed?"red":"gray");
    }
  }
}

class Pea {
  constructor(x,y,type="pea"){
    this.x=x; this.y=y;
    this.type = type;   
    this.dead=false; 
    this.fire=false;
  }
  step(){
    this.x+=4; if(this.x>W) this.dead=true;
    const c=Math.floor(this.x/TW), r=Math.floor(this.y/TH);
    const p=grid[r]?.[c]; 
    if(p instanceof Torchwood && !this.fire){
      this.fire=true;
      this.type="peafire_bullet"; // ƒë·ªïi h√¨nh khi qua Torchwood
    }
    for(const z of zombies){
      if(!z.dead && z.row===Math.floor(this.y/TH) && this.x>z.x-20 && this.x<z.x+20){
        z.hp -= this.fire?20:10; // ƒë·∫°n l·ª≠a s√°t th∆∞∆°ng g·∫•p ƒë√¥i
        if(this.type==="snowpea_bullet") z.slow=1
        this.dead=true; break;
      }
    }
  }
  draw(){
    const im = IMG[this.type] && IMG[this.type].complete ? IMG[this.type] : null;
    if(im){
      ctx.drawImage(im, this.x-12, this.y-12, 24, 24);
    } else {
      ctx.fillStyle = this.fire ? "orange" :
        this.type==="snowpea_bullet" ? "cyan" :
        this.type==="repeater_bullet" ? "yellowgreen" :
        "lime";
      ctx.beginPath(); ctx.arc(this.x,this.y,6,0,Math.PI*2); ctx.fill();
    }
  }
}



class Zombie{
  constructor(row,hp=100,spd=0.2,name="Zombie",color="gray"){
    this.row=row; this.x=W+40; this.y=row*TH+TH/2;
    this.hp=hp; this.base=spd; this.slow=1; this.name=name; this.dead=false; this.color=color;
  }
  step(){
    const s = (this.slow>0 ? this.base*0.5 : this.base);
    this.x -= s; if(this.slow>0) this.slow--;
    const c = Math.floor(this.x/TW), p = grid[this.row][c];
    if(p){
      // N·∫øu l√† m√¨n ƒë√£ s·∫µn s√†ng th√¨ KH√îNG c·∫Øn, ƒë·ªÉ Mine.step() x·ª≠ l√Ω n·ªï
      if(p.type === "mine" && p.armed){
        return;
      }

      // c√¢y b√¨nh th∆∞·ªùng th√¨ v·∫´n b·ªã c·∫Øn
      p.hp -= 0.2;
      if(p.hp <= 0) removePlant(p.row, p.col);
      this.x += s;
    }
    if(this.hp<=0){this.dead=true;}
    if(this.x<0){playing=false; alert("üíÄ Zombie ƒë√£ ƒÉn n√£o! Nh·∫•n R ƒë·ªÉ ch∆°i l·∫°i.");}
  
  }

  draw(){
    const im = IMG.zombie.complete ? IMG.zombie : null;
    if(im){ ctx.drawImage(im, this.x-22, this.y-30, 44, 60); }
    else { ctx.fillStyle=this.color; ctx.fillRect(this.x-22,this.y-30,44,60); }
    ctx.fillStyle="red"; ctx.fillRect(this.x-22, this.y-40, clamp(this.hp,0,44), 5);
  }
}
class FlagZombie extends Zombie{
  constructor(row){ super(row,110,0.32,"Flag Zombie","black"); }
  step(){
    const s = (this.slow>0 ? this.base*0.5 : this.base);
    this.x -= s; if(this.slow>0) this.slow--;
    const c=Math.floor(this.x/TW), p=grid[this.row][c];
    if(p){
    // N·∫øu l√† m√¨n ƒë√£ s·∫µn s√†ng th√¨ KH√îNG c·∫Øn, ƒë·ªÉ Mine.step() x·ª≠ l√Ω n·ªï
    if(p.type === "mine" && p.armed){
      return;
    }

    // c√¢y th∆∞·ªùng th√¨ v·∫´n b·ªã c·∫Øn
    p.hp -= 0.2;
    if(p.hp<=0) removePlant(p.row,p.col);
    this.x += s;
    }
    if(this.hp<=0){this.dead=true;}
    if(this.x<0){playing=false; alert("üíÄ Zombie ƒë√£ ƒÉn n√£o! Nh·∫•n R ƒë·ªÉ ch∆°i l·∫°i.");}
  }
  draw(){
    const im = IMG.flagZombie.complete ? IMG.flagZombie : null;
    if(im){ ctx.drawImage(im, this.x-24, this.y-32, 48, 64); }
    // thanh m√°u
    ctx.fillStyle="red"; ctx.fillRect(this.x-24, this.y-44, clamp(this.hp,0,48), 5);
    // c·ªù
    if(im){ ctx.drawImage(im, this.x+10, this.y-60, 20, 30); }
    else {
      super.draw();
      ctx.fillStyle="white"; ctx.fillRect(this.x+10,this.y-50,3,22);
      ctx.fillStyle="black"; ctx.fillRect(this.x+13,this.y-50,16,10);
    }
  }
}
class MobileZombie extends Zombie {
  constructor(row, hp=50000){
    super(row, hp, 0.03, "MobileZombie", "darkgreen"); 
    // m√°u tr√¢u, ch·∫°y c·ª±c ch·∫≠m
    this.img = IMG.mobilezombie; // th√™m d√≤ng n√†y
  }

  step(){
    if(this.dead) return;

    this.x -= this.base;

    const c = Math.floor(this.x / TW);
    const plant = grid[this.row][c];

    if(plant){
      if(plant instanceof Mine && plant.armed){
        plant.explode(this); // cho m√¨n x·ª≠ l√Ω n·ªï
      } else {
        removePlant(this.row, c); // c√°n n√°t c√¢y th∆∞·ªùng
      }
    }

    if(this.hp <= 0) this.dead = true;
    if(this.x < 0){
      playing = false;
      alert("üíÄ MobileZombie ƒë√£ c√°n n√°t m·ªçi th·ª© v√† v√†o nh√† b·∫°n!");
    }
  }

  draw(){
    const im = this.img && this.img.complete ? this.img : null;
    if(im){
      ctx.drawImage(im, this.x-30, this.y-40, 70, 70);
    } else {
      ctx.fillStyle="darkgreen";
      ctx.fillRect(this.x-30, this.y-40, 60, 60);
    }
    // thanh m√°u
    ctx.fillStyle="red";
    ctx.fillRect(this.x-30, this.y-50, clamp(this.hp/20, 0, 60), 5);
  }
}

class HorseZombie extends Zombie {
  constructor(row, hp){
    super(row, hp, 0.2, "HorseZombie Boss", "darkred"); 
    this.dashCooldown = 100; // ch·ªù dash l·∫°i
    this.dashing = false;
  }
  
  step(){
    super.step();

    // Dash logic
    if(!this.dashing && this.dashCooldown<=0){
      this.dashing = true;
      this.base = 1.2; // tƒÉng t·ªëc khi dash
      setTimeout(()=>{
        this.base = 1.2; 
        this.dashing = false;
        this.dashCooldown = 600;
      }, 2000); // dash trong 3 gi√¢y
    } else {
      this.dashCooldown--;
    }
  }

  draw(){
    const im = IMG.horse && IMG.horse.complete ? IMG.horse : null;
    if(im){
      ctx.drawImage(im, this.x-36, this.y-44, 72, 88);
    } else {
      ctx.fillStyle="darkred";
      ctx.fillRect(this.x-30,this.y-40,60,80);
    }
    // Thanh m√°u d√†i h∆°n ƒë·ªÉ nh√¨n r√µ Boss
    ctx.fillStyle="red";
    ctx.fillRect(this.x-36, this.y-52, clamp(this.hp/10,0,72), 6);
  }
}

class FlorentinoZombie extends Zombie {
  constructor(row, hp){
    super(row, hp, 0.2, "Florentino Boss", "darkred"); 
    this.dashCooldown = 600; // ch·ªù dash l·∫°i
    this.dashing = false;
  }
  
  step(){
    super.step();

    // Dash logic
    if(!this.dashing && this.dashCooldown<=0){
      this.dashing = true;
      this.base = 1.2; // tƒÉng t·ªëc khi dash
      setTimeout(()=>{
        this.base = 1.2; 
        this.dashing = false;
        this.dashCooldown = 600;
      }, 2000); // dash trong 3 gi√¢y
    } else {
      this.dashCooldown--;
    }
  }

  draw(){
    const im = IMG.florentino && IMG.florentino.complete ? IMG.florentino : null;
    if(im){
      ctx.drawImage(im, this.x-36, this.y-44, 72, 88);
    } else {
      ctx.fillStyle="darkred";
      ctx.fillRect(this.x-30,this.y-40,60,80);
    }
    // Thanh m√°u d√†i h∆°n ƒë·ªÉ nh√¨n r√µ Boss
    ctx.fillStyle="red";
    ctx.fillRect(this.x-36, this.y-52, clamp(this.hp/10,0,72), 6);
  }
}

/* ========================== GAME LOGIC ========================== */
function removePlant(r,c){
  const p=grid[r][c]; if(!p) return;
  grid[r][c]=null; plants = plants.filter(x=>x!==p);
}
function placePlant(r,c){
  if(grid[r][c]) return;
  const card=shopList.find(s=>s.id===selected);
  if(!card) return;
  if(sun < card.cost){ alert("Kh√¥ng ƒë·ªß sun!"); return; }
  let p=null;
  if(selected==="peashooter") p=new Peashooter(r,c);
  if(selected==="snowpea")    p=new SnowPea(r,c);
  if(selected==="repeater")   p=new Repeater(r,c);
  if(selected==="gaplin")     p=new Gaplin(r,c);
  if(selected==="cabbage")    p=new Cabbage(r,c);
  if(selected==="sunflower")  p=new Sunflower(r,c);
  if(selected==="wallnut")    p=new Wallnut(r,c);
  if(selected==="bomb")       p=new Bomb(r,c);
  if(selected==="torchwood")  p=new Torchwood(r,c);
  if(selected==="mine")       p=new Mine(r,c);
  if(p){ grid[r][c]=p; plants.push(p); sun-=card.cost; document.getElementById("sun").textContent=sun; }
}

function spawnZombie(){
  const r = Math.floor(Math.random()*ROWS);
  if(zombiesLeft===1){
    zombies.push(new FlagZombie(r));
    if(drum){ drum.currentTime=0; drum.play().catch(()=>{}); }
    banner.style.display="block"; setTimeout(()=>banner.style.display="none", 2500);
  } else {
    const t=Math.random();
    if(t<0.6) zombies.push(new Zombie(r,40+wave*5,0.28,"Normal","gray"));
    else if(t<0.82) zombies.push(new Zombie(r,70+wave*7,0.28,"Conehead","orange"));
    else if(t<0.96) zombies.push(new Zombie(r,120+wave*8,0.26,"Buckethead","brown"));
    else if(t<0.97) zombies.push(new Zombie(r,30+wave*5,0.48,"Runner","purple"));
  }
}

function nextWave(){
  wave++;
   zombiesLeft = 3 + Math.floor(wave*1.2);
   
  if(wave % 5 === 0){ 
  const r = Math.floor(Math.random()*ROWS);
  zombies.push(new MobileZombie(r));
  }

  // üåü N·∫øu l√† wave boss
  if(wave===5 || wave===10 || wave===20 || wave===30 || wave===40 || wave===50){
    let hp;
    if(wave===5)  hp = 100000
    if(wave===10) hp = 200000;
    if(wave===20) hp = 300000;
    if(wave===30) hp = 500000;
    if(wave===40) hp = 700000;
    if(wave===50) hp = 1000000;
    const r = Math.floor(Math.random()*ROWS);
    zombies.push(new FlorentinoZombie(r, hp));
    zombiesLeft = 1; // ch·ªâ c√≥ boss
    if(drum){ drum.currentTime=0; drum.play().catch(()=>{}); }
    
      // üåü Hi·ªáu ·ª©ng Boss
      if(bossSound){ bossSound.currentTime=0; bossSound.play().catch(()=>{}); }
      banner.innerText = "‚öîÔ∏è BOSS FLORENTINO XU·∫§T HI·ªÜN!";
      banner.style.display="block"; 
      setTimeout(()=>banner.style.display="none", 5000);

  }

  // üåü N·∫øu l√† wave boss
  if(wave===5 || wave===10 || wave===20 || wave===30 || wave===40 || wave===50){
  let hp;
  if(wave===5)  hp = 50000
  if(wave===10) hp = 100000;
  if(wave===20) hp = 200000;
  if(wave===30) hp = 300000;
  if(wave===40) hp = 400000;
  if(wave===50) hp = 500000;
  const r = Math.floor(Math.random()*ROWS);
  zombies.push(new HorseZombie(r, hp));
  zombiesLeft = 1; // ch·ªâ c√≥ boss
  if(drum){ drum.currentTime=0; drum.play().catch(()=>{}); }
  }

  // üåü N·∫øu l√† wave boss
if(wave===5 || wave===10 || wave===20 || wave===30 || wave===40 || wave===50){
let hp;
if(wave===5)  hp = 50000
if(wave===10) hp = 100000;
if(wave===20) hp = 200000;
if(wave===30) hp = 300000;
if(wave===40) hp = 400000;
if(wave===50) hp = 500000;
const r = Math.floor(Math.random()*ROWS);
zombies.push(new MobileZombie(r, hp));
zombiesLeft = 1; // ch·ªâ c√≥ boss
if(drum){ drum.currentTime=0; drum.play().catch(()=>{}); }
}

  document.getElementById("wave").textContent=wave;
  // üéµ ƒë·ªïi nh·∫°c n·ªÅn theo wave
  if(wave === 1){
    playBgm("track1"); // wave 1 b·∫Øt ƒë·∫ßu ‚Üí b·∫≠t nh·∫°c 1
  }
  if(wave === 40){
    playBgm("track2"); // wave 40 b·∫Øt ƒë·∫ßu ‚Üí b·∫≠t nh·∫°c 2
  }

  if(wave>50){
    playing=false;
    alert("üéâ B·∫°n ƒë√£ chi·∫øn th·∫Øng sau 50 wave!");
    return;
  }

  zombiesLeft = 6 + wave*2;
  // TƒÉng m·∫≠t ƒë·ªô m·∫°nh t·ª´ wave 10
  if(wave>=10){
    spawnDelay = Math.max(40, 200 - wave*12);
  }else{
    spawnDelay = Math.max(70, 280 - wave*18);
  }
  spawnTimer = spawnDelay; 
  hugeShown=false;
  
}

function reset(){
  sun=50; wave=0; playing=true;
  grid=[...Array(ROWS)].map(()=>Array(COLS).fill(null));
  plants=[]; peas=[]; zombies=[]; suns=[];
  zombiesLeft=6; spawnDelay=250; spawnTimer=spawnDelay; hugeShown=false;
  document.getElementById("sun").textContent=sun;
  document.getElementById("wave").textContent=wave;
}

/* ========================== V·∫º: ·∫¢NH N·ªÄN + L∆Ø·ªöI 5√ó9 ========================== */
function drawBackground(){
  const im = IMG.bg && IMG.bg.complete ? IMG.bg : null;
  if(im){
    // V·∫Ω to√†n ·∫£nh n·ªÅn tr√†n canvas
    ctx.drawImage(im, 0, 0, W, H);
  } else {
    ctx.fillStyle = "#68a"; ctx.fillRect(0,0,W,H);
  }

  // K·∫∫ L∆Ø·ªöI 5√ó9 ‚Äî t·ª± chia ƒë√∫ng 5 h√†ng 9 c·ªôt tr√™n ·∫£nh
  ctx.strokeStyle="rgba(255,255,255,.14)";
  for(let r=1;r<ROWS;r++){
    const y=r*TH; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }
  for(let c=1;c<COLS;c++){
    const x=c*TW; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
  }
}

/* ========================== V√íNG L·∫∂P ========================== */
function step(){
  if(playing){
    // spawn
    if(zombiesLeft>0){ spawnTimer--; if(spawnTimer<=0){ spawnZombie(); zombiesLeft--; spawnTimer=spawnDelay; } }
    else if(zombies.length===0){ nextWave(); }

    plants.forEach(p=>p.step());
    peas.forEach(p=>p.step());
    zombies.forEach(z=>z.step());
    suns.forEach(s=>s.update());

    peas = peas.filter(p=>!p.dead);
    zombies = zombies.filter(z=>!z.dead);
      // üåü N·∫øu kh√¥ng c√≤n Boss n√†o -> t·∫Øt nh·∫°c Boss
      if(!zombies.some(z => z instanceof FlorentinoZombie)){
        bossSound.pause();
      }
    suns = suns.filter(s=>s.life>0);
  }
}

 
/* ========================== SHOP UI ========================== */
const shopDiv=document.getElementById("shop");
function renderShop(){
  shopDiv.innerHTML="";
  shopList.forEach(card=>{
    const el=document.createElement("div");
    el.className="card"+(selected===card.id?" active":"");
    const afford = sun >= card.cost;
    if(!afford) el.classList.add("disabled");
    el.textContent = `${card.name} (${card.cost})`;
    el.onclick=()=>{ selected=card.id; document.getElementById("sel").textContent=card.name.replace(/^[^A-Za-z√Ä-·ªπ ]+ /,''); renderShop(); };
    shopDiv.appendChild(el);
  });
}
renderShop();

/* ========================== INPUT ========================== */
canvas.addEventListener("contextmenu", e=>e.preventDefault());
canvas.addEventListener("mousedown", e=>{
  if (!currentTrack) playBgm("track1"); // ph√°t nh·∫°c l·∫ßn ƒë·∫ßu
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(canvas.width/rect.width);
  const y=(e.clientY-rect.top)*(canvas.height/rect.height);
  const cell = cellOf(x,y); if(!cell) return;

  // Nh·∫∑t sun n·∫øu b·∫•m tr√∫ng
  for(const s of suns){
    if(Math.hypot(s.x-x, s.y-y) < 18){ sun+=s.amt; s.life=0; document.getElementById("sun").textContent=sun; renderShop(); return; }
  }

  if(e.button===0){ // ƒë·∫∑t
    placePlant(cell.r, cell.c);
    renderShop();
  } else if(e.button===2){ // x√≥a
    removePlant(cell.r, cell.c);
  }
});

window.addEventListener("keydown", e=>{
  if(e.key==="r"||e.key==="R"){ reset(); renderShop(); }
},{ once: true});

document.getElementById("restart").onclick=()=>{ reset(); renderShop(); };

// Upload ·∫£nh n·ªÅn t·ª´ m√°y
bgUpload.addEventListener("change", (e)=>{
  const file=e.target.files?.[0];
  if(file){
    const url = URL.createObjectURL(file);
    IMG.bg.src = url; // d√πng ·∫£nh b·∫°n ch·ªçn
  }
});

// B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  step();
  drawBackground();
  plants.forEach(p=>p.draw());
  peas.forEach(p=>p.draw());
  zombies.forEach(z=>z.draw());
  suns.forEach(s=>{
    s.draw();
    ctx.fillStyle="#000";
    ctx.font="12px system-ui";
    ctx.fillText(s.amt, s.x-8, s.y+4);
  });
  requestAnimationFrame(loop);
}
loop(); // üî• g·ªçi v√≤ng l·∫∑p l·∫ßn ƒë·∫ßu

</script>
</body>
</html>
